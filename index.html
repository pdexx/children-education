<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>互動式換錢遊戲</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      margin: 20px;
      /* 阻止手機彈性捲動 */
      overscroll-behavior-y: contain;
    }
    .zone {
      width: 30%;
      min-height: 300px;
      border: 2px dashed #666;
      border-radius: 10px;
      padding: 10px;
      position: relative;
    }
    .zone h2 {
      text-align: center;
    }
    .coin {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      margin: 5px;
      cursor: grab;
      font-weight: bold;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .coin.ten {
      background-color: #ffd700;
    }
    .coin.five {
      background-color: #a9a9a9;
    }
    .coin.one {
      background-color: #d3d3d3;
    }
    .coin.selected {
      outline: 3px solid blue;
    }
    .counter {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 16px;
      font-weight: bold;
      background: #fff8dc;
      padding: 3px 8px;
      border: 1px solid #aaa;
      border-radius: 5px;
    }

    /* 手機版 RWD 樣式 */
    @media (max-width: 600px) {
      body {
        flex-direction: column;
        align-items: center;
      }
      .zone {
        width: 90%;
        margin-bottom: 20px;
      }
      #five-zone {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="ten-zone" class="zone">
    <h2>10元區</h2>
    <div class="coin ten" draggable="true">10</div>
  </div>

  <div id="five-zone" class="zone">
    <h2>5元區</h2>
    <div class="coin five" draggable="true">5</div>
    <div id="five-counter" class="counter">選取：0</div>
  </div>

  <div id="one-zone" class="zone">
    <h2>1元區</h2>
    <div id="one-counter" class="counter">選取：0</div>
  </div>

  <audio id="coin-sound" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
  <audio id="click-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

  <script>
    const tenZone = document.getElementById("ten-zone");
    const fiveZone = document.getElementById("five-zone");
    const oneZone = document.getElementById("one-zone");
    const allZones = [tenZone, fiveZone, oneZone];

    const oneCounter = document.getElementById("one-counter");
    const fiveCounter = document.getElementById("five-counter");

    const coinSound = document.getElementById("coin-sound");
    const clickSound = document.getElementById("click-sound");

    let selectedOnes = [];
    let selectedFives = [];

    // 初始化 13 個 1元
    for (let i = 0; i < 13; i++) {
      addCoin("one", oneZone);
    }

    function updateCounters() {
      oneCounter.textContent = `選取：${selectedOnes.length}`;
      fiveCounter.textContent = `選取：${selectedFives.length}`;
    }

    // 輔助函式：新增硬幣
    function addCoin(type, zone) {
      const coin = document.createElement("div");
      coin.className = `coin ${type}`;
      coin.textContent = type === "ten" ? "10" : type === "five" ? "5" : "1";
      zone.appendChild(coin);
      
      // 為新硬幣添加事件監聽器
      addTouchEvents(coin);
      addDragEvents(coin);
    }

    // --- 網頁版：滑鼠拖曳邏輯 ---
    function addDragEvents(coin) {
      coin.setAttribute("draggable", "true");
      
      coin.addEventListener("dragstart", e => {
        const target = e.target;
        if (!target.classList.contains("coin")) return;
        
        e.dataTransfer.setDragImage(target, 20, 20);

        if (target.classList.contains("ten")) {
          e.dataTransfer.setData("coin-type", "ten");
        } else if (target.classList.contains("five")) {
          if (selectedFives.length > 0) {
              e.dataTransfer.setData("coin-type", "five-group");
              e.dataTransfer.setData("five-count", selectedFives.length);
          } else {
              e.dataTransfer.setData("coin-type", "five-single");
          }
        } else if (target.classList.contains("one")) {
          if (selectedOnes.length > 0 && selectedOnes.length % 5 === 0) {
            e.dataTransfer.setData("coin-type", "one-group");
            e.dataTransfer.setData("one-count", selectedOnes.length);
          } else {
            e.preventDefault();
          }
        }
      });
    }

    allZones.forEach(zone => {
      zone.addEventListener("dragover", e => e.preventDefault());
      zone.addEventListener("drop", e => {
        e.preventDefault();
        const droppedType = e.dataTransfer.getData("coin-type");
        const droppedZone = e.currentTarget;
        handleDropLogic(droppedType, droppedZone);
      });
    });

    // --- 手機版：觸控拖曳邏輯 ---
    function addTouchEvents(coin) {
      coin.addEventListener("touchstart", e => {
        e.preventDefault(); // 阻止頁面滑動
        const target = e.target;
        if (!target.classList.contains("coin")) return;

        // 觸發點擊選取效果
        clickSound.currentTime = 0;
        clickSound.play();
        if (target.classList.contains("one")) {
          if (selectedOnes.includes(target)) {
            target.classList.remove("selected");
            selectedOnes = selectedOnes.filter(c => c !== target);
          } else {
            target.classList.add("selected");
            selectedOnes.push(target);
          }
        } else if (target.classList.contains("five")) {
          if (selectedFives.includes(target)) {
            target.classList.remove("selected");
            selectedFives = selectedFives.filter(c => c !== target);
          } else {
            target.classList.add("selected");
            selectedFives.push(target);
          }
        }
        updateCounters();
      });

      // 觸控結束後，處理換算邏輯
      coin.addEventListener("touchend", e => {
        e.preventDefault();
        const touch = e.changedTouches[0];
        const endElement = document.elementFromPoint(touch.clientX, touch.clientY);
        
        if (endElement && endElement.classList.contains("zone")) {
          const droppedZone = endElement;
          // 模擬拖曳行為，並呼叫換算邏輯
          let droppedType = "";
          if (coin.classList.contains("ten")) {
            droppedType = "ten";
          } else if (coin.classList.contains("five")) {
            if (selectedFives.length > 0) {
              droppedType = "five-group";
            } else {
              droppedType = "five-single";
            }
          } else if (coin.classList.contains("one") && selectedOnes.length > 0 && selectedOnes.length % 5 === 0) {
            droppedType = "one-group";
          }
          
          handleDropLogic(droppedType, droppedZone);
        }
      });
    }

    // --- 核心換算邏輯 ---
    function handleDropLogic(droppedType, droppedZone) {
      if (!droppedType || !droppedZone) return;

      const draggedCoin = document.querySelector(".coin.ten");

      if (droppedType === "ten") {
        if (draggedCoin && droppedZone.id === "five-zone") {
          draggedCoin.remove();
          addCoin("five", fiveZone);
          addCoin("five", fiveZone);
        } else if (draggedCoin && droppedZone.id === "one-zone") {
          draggedCoin.remove();
          for (let i = 0; i < 10; i++) addCoin("one", oneZone);
        } else {
            return;
        }
      }
      else if ((droppedType === "five-single" || droppedType === "five-group") && droppedZone.id === "one-zone") {
        const fiveCount = (droppedType === "five-single") ? 1 : selectedFives.length;
        if (droppedType === "five-group") {
            selectedFives.forEach(c => c.remove());
            selectedFives = [];
        } else {
            const singleFive = document.querySelector(".coin.five");
            if (singleFive) singleFive.remove();
        }
        const oneCount = fiveCount * 5;
        for (let i = 0; i < oneCount; i++) addCoin("one", oneZone);
        updateCounters();
      }
      else if (droppedType === "five-group" && droppedZone.id === "ten-zone") {
        const fiveCount = selectedFives.length;
        if (fiveCount > 0 && fiveCount % 2 === 0) {
          selectedFives.forEach(c => c.remove());
          selectedFives = [];
          const tenCount = fiveCount / 2;
          for (let i = 0; i < tenCount; i++) addCoin("ten", tenZone);
          updateCounters();
        }
      }
      else if (droppedType === "one-group") {
        const oneCount = selectedOnes.length;
        if (droppedZone.id === "five-zone" && oneCount % 5 === 0) {
          selectedOnes.forEach(c => c.remove());
          selectedOnes = [];
          const fiveCount = oneCount / 5;
          for (let i = 0; i < fiveCount; i++) addCoin("five", fiveZone);
          updateCounters();
        } else if (droppedZone.id === "ten-zone" && oneCount % 10 === 0) {
          selectedOnes.forEach(c => c.remove());
          selectedOnes = [];
          const tenCount = oneCount / 10;
          for (let i = 0; i < tenCount; i++) addCoin("ten", tenZone);
          updateCounters();
        }
      }
      coinSound.currentTime = 0;
      coinSound.play();
    }
    
    // 初始化硬幣的拖曳與觸控事件
    document.querySelectorAll('.coin').forEach(coin => {
        addTouchEvents(coin);
        addDragEvents(coin);
    });

  </script>
</body>
</html>