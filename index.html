<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>互動式換錢遊戲</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      margin: 20px;
      overscroll-behavior-y: contain;
    }
    .zone {
      width: 30%;
      min-height: 300px;
      border: 2px dashed #666;
      border-radius: 10px;
      padding: 10px;
      position: relative;
    }
    .zone h2 {
      text-align: center;
    }
    .coin {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      margin: 5px;
      cursor: grab;
      font-weight: bold;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .coin.ten {
      background-color: #ffd700;
    }
    .coin.five {
      background-color: #a9a9a9;
    }
    .coin.one {
      background-color: #d3d3d3;
    }
    .coin.selected {
      outline: 3px solid blue;
    }
    .counter {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 16px;
      font-weight: bold;
      background: #fff8dc;
      padding: 3px 8px;
      border: 1px solid #aaa;
      border-radius: 5px;
    }
    @media (max-width: 600px) {
      body {
        flex-direction: column;
        align-items: center;
      }
      .zone {
        width: 90%;
        margin-bottom: 20px;
      }
      #five-zone {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="ten-zone" class="zone">
    <h2>10元區</h2>
    <div class="coin ten">10</div>
  </div>

  <div id="five-zone" class="zone">
    <h2>5元區</h2>
    <div class="coin five">5</div>
    <div id="five-counter" class="counter">選取：0</div>
  </div>

  <div id="one-zone" class="zone">
    <h2>1元區</h2>
    <div class="coin one">1</div>
    <div id="one-counter" class="counter">選取：0</div>
  </div>

  <audio id="coin-sound" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
  <audio id="click-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

  <script>
    const tenZone = document.getElementById("ten-zone");
    const fiveZone = document.getElementById("five-zone");
    const oneZone = document.getElementById("one-zone");
    const allZones = [tenZone, fiveZone, oneZone];

    const oneCounter = document.getElementById("one-counter");
    const fiveCounter = document.getElementById("five-counter");

    const coinSound = document.getElementById("coin-sound");
    const clickSound = document.getElementById("click-sound");

    let selectedOnes = [];
    let selectedFives = [];
    let draggedCoinType = null;

    // 初始化 13 個 1元，並為所有硬幣設定事件
    for (let i = 0; i < 13; i++) {
      addCoin("one", oneZone);
    }
    document.querySelectorAll('.coin').forEach(coin => {
      addEventsToCoin(coin);
    });

    function updateCounters() {
      oneCounter.textContent = `選取：${selectedOnes.length}`;
      fiveCounter.textContent = `選取：${selectedFives.length}`;
    }

    // 新增硬幣並為其設定事件
    function addCoin(type, zone) {
      const coin = document.createElement("div");
      coin.className = `coin ${type}`;
      coin.textContent = type === "ten" ? "10" : type === "five" ? "5" : "1";
      addEventsToCoin(coin);
      zone.appendChild(coin);
    }

    // 統一為所有硬幣添加事件
    function addEventsToCoin(coin) {
      coin.addEventListener('mousedown', startDrag);
      coin.addEventListener('mouseup', endDrag);
      coin.addEventListener('click', selectCoin);
      coin.addEventListener('touchstart', startTouchDrag, { passive: false });
      coin.addEventListener('touchend', endTouchDrag);
    }

    // --- 網頁版：滑鼠拖曳邏輯 ---
    function startDrag(e) {
      const target = e.target;
      if (!target.classList.contains("coin")) return;
      
      draggedCoinType = getDraggedCoinType(target);
      if (!draggedCoinType) {
        e.preventDefault();
      }

      // 監聽 mousemove 以實現拖曳視覺效果
      document.addEventListener('mousemove', drag);
    }

    function drag(e) {
      // 實作拖曳中的視覺效果
    }

    function endDrag(e) {
      const target = e.target;
      if (!target.classList.contains("coin")) return;

      const dropZone = e.target.closest('.zone');
      if (dropZone) {
        handleDropLogic(draggedCoinType, dropZone);
      }
      
      draggedCoinType = null;
      document.removeEventListener('mousemove', drag);
    }

    // --- 手機版：觸控拖曳邏輯 ---
    function startTouchDrag(e) {
      e.preventDefault(); // 阻止頁面滑動
      const target = e.target;
      if (!target.classList.contains("coin")) return;

      // 觸發點擊選取效果
      selectCoin(e);
    }

    function endTouchDrag(e) {
      e.preventDefault();
      const touch = e.changedTouches[0];
      const endElement = document.elementFromPoint(touch.clientX, touch.clientY);
      
      if (endElement) {
        const dropZone = endElement.closest('.zone');
        if (dropZone) {
          const selectedCoinType = getDraggedCoinType(e.target);
          if (selectedCoinType) {
            handleDropLogic(selectedCoinType, dropZone);
          }
        }
      }
    }

    // 輔助函式：取得拖曳的硬幣類型
    function getDraggedCoinType(target) {
      if (target.classList.contains("ten")) {
        return "ten";
      } else if (target.classList.contains("five")) {
        if (selectedFives.length > 0) {
          return "five-group";
        } else {
          return "five-single";
        }
      } else if (target.classList.contains("one")) {
        if (selectedOnes.length > 0 && selectedOnes.length % 5 === 0) {
          return "one-group";
        }
      }
      return null;
    }

    // 核心換算邏輯
    function handleDropLogic(droppedType, droppedZone) {
      if (!droppedType || !droppedZone) return;

      // 由於我們改用客製化邏輯，需手動移除硬幣
      if (droppedType === "ten") {
        const tenCoin = tenZone.querySelector('.coin.ten');
        if (tenCoin) tenCoin.remove();
        if (droppedZone.id === "five-zone") {
          addCoin("five", fiveZone);
          addCoin("five", fiveZone);
        } else if (droppedZone.id === "one-zone") {
          for (let i = 0; i < 10; i++) addCoin("one", oneZone);
        }
      }
      else if ((droppedType === "five-single" || droppedType === "five-group") && droppedZone.id === "one-zone") {
        const fiveCount = (droppedType === "five-single") ? 1 : selectedFives.length;
        if (droppedType === "five-group") {
          selectedFives.forEach(c => c.remove());
          selectedFives = [];
        } else {
          const singleFive = fiveZone.querySelector('.coin.five');
          if (singleFive) singleFive.remove();
        }
        for (let i = 0; i < fiveCount * 5; i++) addCoin("one", oneZone);
        updateCounters();
      }
      else if (droppedType === "five-group" && droppedZone.id === "ten-zone") {
        const fiveCount = selectedFives.length;
        if (fiveCount > 0 && fiveCount % 2 === 0) {
          selectedFives.forEach(c => c.remove());
          selectedFives = [];
          for (let i = 0; i < fiveCount / 2; i++) addCoin("ten", tenZone);
          updateCounters();
        }
      }
      else if (droppedType === "one-group") {
        const oneCount = selectedOnes.length;
        if (droppedZone.id === "five-zone" && oneCount % 5 === 0) {
          selectedOnes.forEach(c => c.remove());
          selectedOnes = [];
          for (let i = 0; i < oneCount / 5; i++) addCoin("five", fiveZone);
          updateCounters();
        } else if (droppedZone.id === "ten-zone" && oneCount % 10 === 0) {
          selectedOnes.forEach(c => c.remove());
          selectedOnes = [];
          for (let i = 0; i < oneCount / 10; i++) addCoin("ten", tenZone);
          updateCounters();
        }
      }
      coinSound.currentTime = 0;
      coinSound.play();
    }

    // 點擊選取硬幣
    function selectCoin(e) {
      const coin = e.target;
      if (!coin.classList.contains("coin")) return;
      clickSound.currentTime = 0;
      clickSound.play();

      if (coin.classList.contains("one")) {
        if (selectedOnes.includes(coin)) {
          coin.classList.remove("selected");
          selectedOnes = selectedOnes.filter(c => c !== coin);
        } else {
          coin.classList.add("selected");
          selectedOnes.push(coin);
        }
      } else if (coin.classList.contains("five")) {
        if (selectedFives.includes(coin)) {
          coin.classList.remove("selected");
          selectedFives = selectedFives.filter(c => c !== coin);
        } else {
          coin.classList.add("selected");
          selectedFives.push(coin);
        }
      }
      updateCounters();
    }
  </script>
</body>
</html>