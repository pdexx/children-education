<script>
    const tenZone = document.getElementById("ten-zone");
    const fiveZone = document.getElementById("five-zone");
    const oneZone = document.getElementById("one-zone");

    const oneCounter = document.getElementById("one-counter");
    const fiveCounter = document.getElementById("five-counter");

    const coinSound = document.getElementById("coin-sound");
    const clickSound = document.getElementById("click-sound");

    let selectedOnes = [];
    let selectedFives = [];

    // 初始化 13 個 1元
    for (let i = 0; i < 13; i++) {
      addCoin("one", oneZone);
    }

    function updateCounters() {
      oneCounter.textContent = `選取：${selectedOnes.length}`;
      fiveCounter.textContent = `選取：${selectedFives.length}`;
    }

    // 事件委託：統一處理拖曳行為
    document.addEventListener("dragstart", e => {
      const target = e.target;
      if (!target.classList.contains("coin")) {
        // 如果不是硬幣，則不處理
        e.preventDefault();
        return;
      }
      
      // 判斷是否為觸控拖曳 (e.dataTransfer 會是 null)
      if (!e.dataTransfer) {
        e.preventDefault(); // 阻止手機頁面滑動
      }

      e.dataTransfer.setDragImage(target, 20, 20);

      if (target.classList.contains("ten")) {
        e.dataTransfer.setData("coin-type", "ten");
      } else if (target.classList.contains("five")) {
        if (selectedFives.length > 0) {
            e.dataTransfer.setData("coin-type", "five-group");
            e.dataTransfer.setData("five-count", selectedFives.length);
        } else {
            e.dataTransfer.setData("coin-type", "five-single");
        }
      } else if (target.classList.contains("one")) {
        if (selectedOnes.length > 0 && selectedOnes.length % 5 === 0) {
          e.dataTransfer.setData("coin-type", "one-group");
          e.dataTransfer.setData("one-count", selectedOnes.length);
        } else {
          // 如果選取數量不符，則阻止拖曳
          e.preventDefault();
        }
      }
    });

    // 拖曳放置邏輯
    const zones = [tenZone, fiveZone, oneZone];
    zones.forEach(zone => {
      zone.addEventListener("dragover", e => e.preventDefault());

      zone.addEventListener("drop", e => {
        e.preventDefault();
        const droppedType = e.dataTransfer.getData("coin-type");
        const droppedZone = e.currentTarget;
        const draggedCoin = document.querySelector(".coin.ten");

        // 處理 10 元硬幣的換算
        if (droppedType === "ten") {
          if (draggedCoin && droppedZone.id === "five-zone") {
            draggedCoin.remove();
            addCoin("five", fiveZone);
            addCoin("five", fiveZone);
            coinSound.currentTime = 0;
            coinSound.play();
          } else if (draggedCoin && droppedZone.id === "one-zone") {
            draggedCoin.remove();
            for (let i = 0; i < 10; i++) addCoin("one", oneZone);
            coinSound.currentTime = 0;
            coinSound.play();
          }
        }

        // 處理 5 元硬幣（單個或多個）到 1 元區的換算
        else if ((droppedType === "five-single" || droppedType === "five-group") && droppedZone.id === "one-zone") {
            const fiveCount = (droppedType === "five-single") ? 1 : parseInt(e.dataTransfer.getData("five-count"), 10);
            
            if (droppedType === "five-group") {
                selectedFives.forEach(c => c.remove());
                selectedFives = [];
            } else {
                const singleFive = document.querySelector(".coin.five");
                if (singleFive) singleFive.remove();
            }

            const oneCount = fiveCount * 5;
            for (let i = 0; i < oneCount; i++) addCoin("one", oneZone);
            updateCounters();
            coinSound.currentTime = 0;
            coinSound.play();
        }

        // 處理 5 元硬幣群組到 10 元區的換算
        else if (droppedType === "five-group" && droppedZone.id === "ten-zone") {
          const fiveCount = parseInt(e.dataTransfer.getData("five-count"), 10);
          if (fiveCount > 0 && fiveCount % 2 === 0) {
            selectedFives.forEach(c => c.remove());
            selectedFives = [];
            const tenCount = fiveCount / 2;
            for (let i = 0; i < tenCount; i++) addCoin("ten", tenZone);
            updateCounters();
            coinSound.currentTime = 0;
            coinSound.play();
          }
        }

        // 處理 1 元硬幣群組的換算
        else if (droppedType === "one-group") {
          const oneCount = parseInt(e.dataTransfer.getData("one-count"), 10);
          if (droppedZone.id === "five-zone" && oneCount % 5 === 0) {
            selectedOnes.forEach(c => c.remove());
            selectedOnes = [];
            const fiveCount = oneCount / 5;
            for (let i = 0; i < fiveCount; i++) addCoin("five", fiveZone);
            updateCounters();
            coinSound.currentTime = 0;
            coinSound.play();
          } else if (droppedZone.id === "ten-zone" && oneCount % 10 === 0) {
            selectedOnes.forEach(c => c.remove());
            selectedOnes = [];
            const tenCount = oneCount / 10;
            for (let i = 0; i < tenCount; i++) addCoin("ten", tenZone);
            updateCounters();
            coinSound.currentTime = 0;
            coinSound.play();
          }
        }
      });
    });

    // 點擊選取硬幣
    document.addEventListener("click", e => {
      const coin = e.target;
      if (!coin.classList.contains("coin")) return;
      clickSound.currentTime = 0;
      clickSound.play();

      if (coin.classList.contains("one")) {
        if (selectedOnes.includes(coin)) {
          coin.classList.remove("selected");
          selectedOnes = selectedOnes.filter(c => c !== coin);
        } else {
          coin.classList.add("selected");
          selectedOnes.push(coin);
        }
      } else if (coin.classList.contains("five")) {
        if (selectedFives.includes(coin)) {
          coin.classList.remove("selected");
          selectedFives = selectedFives.filter(c => c !== coin);
        } else {
          coin.classList.add("selected");
          selectedFives.push(coin);
        }
      }
      updateCounters();
    });

    // 輔助函式：新增硬幣
    function addCoin(type, zone) {
      const coin = document.createElement("div");
      coin.className = `coin ${type}`;
      coin.textContent = type === "ten" ? "10" : type === "five" ? "5" : "1";
      coin.setAttribute("draggable", "true");
      zone.appendChild(coin);
    }
  </script>